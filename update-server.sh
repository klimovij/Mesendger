#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะพะฑะฝะพะฒะปะตะฝะธั ะฟัะพะตะบัะฐ ะฝะฐ ัะตัะฒะตัะต Google Cloud
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./update-server.sh

set -e  # ะััะฐะฝะพะฒะธัั ะฒัะฟะพะปะฝะตะฝะธะต ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะพะตะบัะฐ..."

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ะะพะปััะฐะตะผ ะฟััั ะบ ะดะธัะตะบัะพัะธะธ ัะบัะธะฟัะฐ
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "server/server.js" ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ: ัะฐะนะป server/server.js ะฝะต ะฝะฐะนะดะตะฝ${NC}"
    echo "ะฃะฑะตะดะธัะตัั, ััะพ ัะบัะธะฟั ะทะฐะฟััะตะฝ ะธะท ะดะธัะตะบัะพัะธะธ mesendger/telegram-clone"
    exit 1
fi

# ะจะฐะณ 1: ะะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต ะฑะฐะทั ะดะฐะฝะฝัั
echo -e "\n${YELLOW}๐ฆ ะจะฐะณ 1: ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ ะฑะฐะทั ะดะฐะฝะฝัั...${NC}"
if [ -f "server/messenger.db" ]; then
    BACKUP_NAME="server/messenger.db.backup_$(date +%Y%m%d_%H%M%S)"
    cp "server/messenger.db" "$BACKUP_NAME"
    echo -e "${GREEN}โ ะะตะทะตัะฒะฝะฐั ะบะพะฟะธั ัะพะทะดะฐะฝะฐ: $BACKUP_NAME${NC}"
else
    echo -e "${YELLOW}โ๏ธ  ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะต ะฝะฐะนะดะตะฝะฐ, ะฟัะพะฟััะบะฐะตะผ ัะตะทะตัะฒะฝะพะต ะบะพะฟะธัะพะฒะฐะฝะธะต${NC}"
fi

# ะจะฐะณ 2: ะััะฐะฝะพะฒะบะฐ ะฟัะธะปะพะถะตะฝะธั
echo -e "\n${YELLOW}๐ ะจะฐะณ 2: ะััะฐะฝะพะฒะบะฐ ะฟัะธะปะพะถะตะฝะธั...${NC}"

# ะัะพะฒะตััะตะผ PM2
if command -v pm2 &> /dev/null; then
    if pm2 list | grep -q "mesendger"; then
        echo "ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2 ะฟัะพัะตัั..."
        pm2 stop mesendger || true
        echo -e "${GREEN}โ ะัะธะปะพะถะตะฝะธะต ะพััะฐะฝะพะฒะปะตะฝะพ ัะตัะตะท PM2${NC}"
    else
        echo "PM2 ะฟัะพัะตัั ะฝะต ะฝะฐะนะดะตะฝ"
    fi
fi

# ะัะพะฒะตััะตะผ systemd
if systemctl is-active --quiet mesendger 2>/dev/null; then
    echo "ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ systemd ัะตัะฒะธั..."
    sudo systemctl stop mesendger || true
    echo -e "${GREEN}โ ะัะธะปะพะถะตะฝะธะต ะพััะฐะฝะพะฒะปะตะฝะพ ัะตัะตะท systemd${NC}"
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะพัะตััั Node.js ะฝะฐะฟััะผัั
NODE_PIDS=$(ps aux | grep "node.*server.js" | grep -v grep | awk '{print $2}')
if [ ! -z "$NODE_PIDS" ]; then
    echo "ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะพัะตััั Node.js..."
    for PID in $NODE_PIDS; do
        kill -9 $PID 2>/dev/null || true
    done
    sleep 2
    echo -e "${GREEN}โ ะัะพัะตััั Node.js ะพััะฐะฝะพะฒะปะตะฝั${NC}"
fi

# ะจะฐะณ 3: ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท Git
echo -e "\n${YELLOW}๐ฅ ะจะฐะณ 3: ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ัะตัะตะท Git...${NC}"

if [ ! -d ".git" ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ: ะดะธัะตะบัะพัะธั .git ะฝะต ะฝะฐะนะดะตะฝะฐ${NC}"
    echo "ะญัะพ ะฝะต Git ัะตะฟะพะทะธัะพัะธะน. ะะฑะฝะพะฒะปะตะฝะธะต ัะตัะตะท Git ะฟัะพะฟััะตะฝะพ."
else
    # ะกะพััะฐะฝัะตะผ ัะตะบััะธะต ะธะทะผะตะฝะตะฝะธั
    git stash || true
    
    # ะะพะปััะฐะตะผ ะฟะพัะปะตะดะฝะธะต ะธะทะผะตะฝะตะฝะธั
    CURRENT_BRANCH=$(git branch --show-current)
    echo "ะขะตะบััะฐั ะฒะตัะบะฐ: $CURRENT_BRANCH"
    
    git fetch origin
    
    # ะะพะบะฐะทัะฒะฐะตะผ ััะฐััั
    if [ -n "$(git status --porcelain)" ]; then
        echo -e "${YELLOW}โ๏ธ  ะััั ะฝะตะทะฐะบะพะผะผะธัะตะฝะฝัะต ะธะทะผะตะฝะตะฝะธั${NC}"
        read -p "ะัะพะดะพะปะถะธัั ะพะฑะฝะพะฒะปะตะฝะธะต? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${RED}โ ะะฑะฝะพะฒะปะตะฝะธะต ะพัะผะตะฝะตะฝะพ${NC}"
            exit 1
        fi
    fi
    
    # ะะฑะฝะพะฒะปัะตะผ ะบะพะด
    git pull origin "$CURRENT_BRANCH"
    
    # ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะพััะฐะฝะตะฝะฝัะต ะธะทะผะตะฝะตะฝะธั
    git stash pop || true
    
    echo -e "${GREEN}โ ะะพะด ะพะฑะฝะพะฒะปะตะฝ${NC}"
fi

# ะจะฐะณ 4: ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ัะตัะฒะตัะฐ
echo -e "\n${YELLOW}๐ฆ ะจะฐะณ 4: ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ัะตัะฒะตัะฐ...${NC}"
cd server
if [ -f "package.json" ]; then
    npm install
    echo -e "${GREEN}โ ะะฐะฒะธัะธะผะพััะธ ัะตัะฒะตัะฐ ัััะฐะฝะพะฒะปะตะฝั${NC}"
else
    echo -e "${RED}โ ะัะธะฑะบะฐ: package.json ะฝะต ะฝะฐะนะดะตะฝ${NC}"
    exit 1
fi
cd ..

# ะจะฐะณ 5: ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะบะปะธะตะฝัะฐ
echo -e "\n${YELLOW}๐ฆ ะจะฐะณ 5: ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะบะปะธะตะฝัะฐ...${NC}"
cd client-react
if [ -f "package.json" ]; then
    npm install
    echo -e "${GREEN}โ ะะฐะฒะธัะธะผะพััะธ ะบะปะธะตะฝัะฐ ัััะฐะฝะพะฒะปะตะฝั${NC}"
else
    echo -e "${RED}โ ะัะธะฑะบะฐ: package.json ะฝะต ะฝะฐะนะดะตะฝ${NC}"
    exit 1
fi

# ะจะฐะณ 6: ะกะฑะพัะบะฐ ะบะปะธะตะฝััะบะพะณะพ ะฟัะธะปะพะถะตะฝะธั
echo -e "\n${YELLOW}๐จ ะจะฐะณ 6: ะกะฑะพัะบะฐ ะบะปะธะตะฝััะบะพะณะพ ะฟัะธะปะพะถะตะฝะธั...${NC}"
npm run build
if [ $? -eq 0 ]; then
    echo -e "${GREEN}โ ะะปะธะตะฝััะบะพะต ะฟัะธะปะพะถะตะฝะธะต ัะพะฑัะฐะฝะพ${NC}"
else
    echo -e "${RED}โ ะัะธะฑะบะฐ ะฟัะธ ัะฑะพัะบะต ะบะปะธะตะฝััะบะพะณะพ ะฟัะธะปะพะถะตะฝะธั${NC}"
    exit 1
fi
cd ..

# ะจะฐะณ 7: ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
echo -e "\n${YELLOW}๐ ะจะฐะณ 7: ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั...${NC}"
if [ -f "server/messenger.db" ]; then
    DB_SIZE=$(du -h "server/messenger.db" | cut -f1)
    echo -e "${GREEN}โ ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะฐะนะดะตะฝะฐ (ัะฐะทะผะตั: $DB_SIZE)${NC}"
else
    echo -e "${YELLOW}โ๏ธ  ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะต ะฝะฐะนะดะตะฝะฐ. ะัะดะตั ัะพะทะดะฐะฝะฐ ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต${NC}"
fi

# ะจะฐะณ 8: ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั
echo -e "\n${YELLOW}๐ ะจะฐะณ 8: ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั...${NC}"

# ะัะพะฒะตััะตะผ, ะบะฐะบะพะน ะผะตัะพะด ะทะฐะฟััะบะฐ ะธัะฟะพะปัะทะพะฒะฐัั
if command -v pm2 &> /dev/null; then
    echo "ะะฐะฟััะบะฐะตะผ ัะตัะตะท PM2..."
    cd server
    pm2 start server.js --name mesendger || pm2 restart mesendger
    pm2 save
    echo -e "${GREEN}โ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ ัะตัะตะท PM2${NC}"
    echo "ะัะพัะผะพัั ะปะพะณะพะฒ: pm2 logs mesendger"
elif systemctl list-unit-files | grep -q "mesendger.service"; then
    echo "ะะฐะฟััะบะฐะตะผ ัะตัะตะท systemd..."
    sudo systemctl start mesendger
    echo -e "${GREEN}โ ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ ัะตัะตะท systemd${NC}"
    echo "ะัะพัะผะพัั ะปะพะณะพะฒ: sudo journalctl -u mesendger -f"
else
    echo -e "${YELLOW}โ๏ธ  PM2 ะธ systemd ะฝะต ะฝะฐัััะพะตะฝั. ะะฐะฟัััะธัะต ะฟัะธะปะพะถะตะฝะธะต ะฒัััะฝัั:${NC}"
    echo "cd server && node server.js"
fi

# ะัะพะณะพะฒะฐั ะธะฝัะพัะผะฐัะธั
echo -e "\n${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}โ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ ััะฟะตัะฝะพ!${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo "๐ ะกะปะตะดัััะธะต ัะฐะณะธ:"
echo "1. ะัะพะฒะตัััะต ัะฐะฑะพัั ะฟัะธะปะพะถะตะฝะธั ะฒ ะฑัะฐัะทะตัะต"
echo "2. ะฃะฑะตะดะธัะตัั, ััะพ ัะบัะธะฟั export_to_db.ps1 ะฝะฐ ัะฐะฑะพัะตะผ ัะตัะฒะตัะต ัะบะฐะทัะฒะฐะตั ะฝะฐ ะฟัะฐะฒะธะปัะฝัะน URL"
echo "3. ะัะพะฒะตัััะต ะธะผะฟะพัั ะดะฐะฝะฝัั ั ัะฐะฑะพัะตะณะพ ัะตัะฒะตัะฐ"
echo ""
echo "๐ ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:"
echo "  - ะัะพัะผะพัั ะปะพะณะพะฒ (PM2): pm2 logs mesendger"
echo "  - ะัะพัะผะพัั ะปะพะณะพะฒ (systemd): sudo journalctl -u mesendger -f"
echo "  - ะกัะฐััั (PM2): pm2 status"
echo "  - ะกัะฐััั (systemd): sudo systemctl status mesendger"
echo ""

